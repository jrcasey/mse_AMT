<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importModel</title>
  <meta name="keywords" content="importModel">
  <meta name="description" content="importModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; importModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importModel(fileName,removeExcMets,isCOBRA,supressWarnings) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importModel
   Import a constraint-based model from a SBML file

   fileName        a SBML file to import
   removeExcMets   true if exchange metabolites should be removed. This is
                   needed to be able to run simulations, but it could also
                   be done using simplifyModel at a later stage (opt,
                   default true)
   isCOBRA         true if the SBML-file is a COBRA Toolbox file (opt, default
                   false)
   supressWarnings true if warnings regarding the model structure should
                   be supressed (opt, default false)

   model
       description      description of model contents
       id               model ID
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       genes            list of all genes
       geneComps        compartments for reactions
       geneMiriams      structure with MIRIAM information about the genes
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       unconstrained    true if the metabolite is an exchange metabolite

   Loads models in the COBRA Toolbox format and in the format used in
   the yeast consensus reconstruction. The resulting structure is compatible
   with COBRA Toolbox. A number of consistency checks are performed in order
   to ensure that the model is valid. Take these warnings seriously and modify the
   model structure to solve them. The RAVEN Toolbox is made to function
   only on consistent models, and the only checks performed are when the
   model is imported. You can use exportToExcelFormat, modify the model in
   Microsoft Excel and then reimport it using importExcelModel (or remake
   the SBML file using SBMLFromExcel)

   NOTE: This script requires that libSBML is installed.

   NOTE: All IDs are assumed to be named C_, M_, E_, R_ for compartments,
         metabolites, genes, and reactions. This is true for models
         generated by SBMLFromExcel and those that follow the yeast
         consensus network model formulation.

   Usage: model=importModel(fileName,removeExcMets,isCOBRA,supressWarnings)

   Rasmus Agren, 2014-01-09</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)</a></li><li><a href="#_sub2" class="code">function miriamStruct=parseMiriam(searchString)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importModel(fileName,removeExcMets,isCOBRA,supressWarnings)</a>
0002 <span class="comment">% importModel</span>
0003 <span class="comment">%   Import a constraint-based model from a SBML file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   fileName        a SBML file to import</span>
0006 <span class="comment">%   removeExcMets   true if exchange metabolites should be removed. This is</span>
0007 <span class="comment">%                   needed to be able to run simulations, but it could also</span>
0008 <span class="comment">%                   be done using simplifyModel at a later stage (opt,</span>
0009 <span class="comment">%                   default true)</span>
0010 <span class="comment">%   isCOBRA         true if the SBML-file is a COBRA Toolbox file (opt, default</span>
0011 <span class="comment">%                   false)</span>
0012 <span class="comment">%   supressWarnings true if warnings regarding the model structure should</span>
0013 <span class="comment">%                   be supressed (opt, default false)</span>
0014 <span class="comment">%</span>
0015 <span class="comment">%   model</span>
0016 <span class="comment">%       description      description of model contents</span>
0017 <span class="comment">%       id               model ID</span>
0018 <span class="comment">%       rxns             reaction ids</span>
0019 <span class="comment">%       mets             metabolite ids</span>
0020 <span class="comment">%       S                stoichiometric matrix</span>
0021 <span class="comment">%       lb               lower bounds</span>
0022 <span class="comment">%       ub               upper bounds</span>
0023 <span class="comment">%       rev              reversibility vector</span>
0024 <span class="comment">%       c                objective coefficients</span>
0025 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0026 <span class="comment">%       comps            compartment ids</span>
0027 <span class="comment">%       compNames        compartment names</span>
0028 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0029 <span class="comment">%                        surrounding each of the compartments</span>
0030 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0031 <span class="comment">%                        compartments</span>
0032 <span class="comment">%       rxnNames         reaction description</span>
0033 <span class="comment">%       rxnComps         compartments for reactions</span>
0034 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0035 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0036 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0037 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0038 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0039 <span class="comment">%       genes            list of all genes</span>
0040 <span class="comment">%       geneComps        compartments for reactions</span>
0041 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0042 <span class="comment">%       metNames         metabolite description</span>
0043 <span class="comment">%       metComps         compartments for metabolites</span>
0044 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0045 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0046 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0047 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0048 <span class="comment">%</span>
0049 <span class="comment">%   Loads models in the COBRA Toolbox format and in the format used in</span>
0050 <span class="comment">%   the yeast consensus reconstruction. The resulting structure is compatible</span>
0051 <span class="comment">%   with COBRA Toolbox. A number of consistency checks are performed in order</span>
0052 <span class="comment">%   to ensure that the model is valid. Take these warnings seriously and modify the</span>
0053 <span class="comment">%   model structure to solve them. The RAVEN Toolbox is made to function</span>
0054 <span class="comment">%   only on consistent models, and the only checks performed are when the</span>
0055 <span class="comment">%   model is imported. You can use exportToExcelFormat, modify the model in</span>
0056 <span class="comment">%   Microsoft Excel and then reimport it using importExcelModel (or remake</span>
0057 <span class="comment">%   the SBML file using SBMLFromExcel)</span>
0058 <span class="comment">%</span>
0059 <span class="comment">%   NOTE: This script requires that libSBML is installed.</span>
0060 <span class="comment">%</span>
0061 <span class="comment">%   NOTE: All IDs are assumed to be named C_, M_, E_, R_ for compartments,</span>
0062 <span class="comment">%         metabolites, genes, and reactions. This is true for models</span>
0063 <span class="comment">%         generated by SBMLFromExcel and those that follow the yeast</span>
0064 <span class="comment">%         consensus network model formulation.</span>
0065 <span class="comment">%</span>
0066 <span class="comment">%   Usage: model=importModel(fileName,removeExcMets,isCOBRA,supressWarnings)</span>
0067 <span class="comment">%</span>
0068 <span class="comment">%   Rasmus Agren, 2014-01-09</span>
0069 <span class="comment">%</span>
0070 
0071 <span class="keyword">if</span> nargin&lt;2
0072     removeExcMets=true;
0073 <span class="keyword">end</span>
0074 
0075 <span class="keyword">if</span> nargin&lt;3
0076     isCOBRA=false;
0077 <span class="keyword">end</span>
0078 
0079 <span class="keyword">if</span> nargin&lt;4
0080     supressWarnings=false;
0081 <span class="keyword">end</span>
0082 
0083 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0084 <span class="comment">%from Excel</span>
0085 model=[];
0086 model.description=[];
0087 model.id=[];
0088 model.annotation=[];
0089 model.rxns={};
0090 model.mets={};
0091 model.S=[];
0092 model.lb=[];
0093 model.ub=[];
0094 model.rev=[];
0095 model.c=[];
0096 model.b=[];
0097 model.comps={};
0098 model.compNames={};
0099 model.compOutside={};
0100 model.compMiriams={};
0101 model.rxnNames={};
0102 model.rxnComps=[];
0103 model.grRules={};
0104 model.rxnGeneMat=[];
0105 model.subSystems={};
0106 model.eccodes={};
0107 model.rxnMiriams={};
0108 model.genes={};
0109 model.geneComps=[];
0110 model.geneMiriams={};
0111 model.metNames={};
0112 model.metComps=[];
0113 model.inchis={};
0114 model.metFormulas={};
0115 model.metMiriams={};
0116 model.unconstrained=[];
0117 model.metCharge=[];
0118 
0119 <span class="comment">%Load the model using libSBML</span>
0120 modelSBML = TranslateSBML(fileName);
0121 
0122 <span class="keyword">if</span> isempty(modelSBML)
0123     EM=<span class="string">'There is a problem with the SBML file. Try using the SBML Validator at http://sbml.org/Facilities/Validator'</span>;
0124     dispEM(EM);
0125 <span class="keyword">end</span>
0126 
0127 <span class="comment">%Retrieve compartment names and IDs</span>
0128 compartmentNames=cell(numel(modelSBML.compartment),1);
0129 compartmentIDs=cell(numel(modelSBML.compartment),1);
0130 compartmentOutside=cell(numel(modelSBML.compartment),1);
0131 compartmentMiriams=cell(numel(modelSBML.compartment),1);
0132 
0133 <span class="keyword">for</span> i=1:numel(modelSBML.compartment)
0134     compartmentNames{i}=modelSBML.compartment(i).name;
0135     <span class="keyword">if</span> isCOBRA==true
0136         <span class="keyword">try</span> <span class="keyword">if</span> strcmpi(modelSBML.compartment(i).id(1:2),<span class="string">'C_'</span>)
0137                 compartmentIDs{i}=modelSBML.compartment(i).id(3:end);
0138             <span class="keyword">else</span>
0139                 compartmentIDs{i}=modelSBML.compartment(i).id;
0140             <span class="keyword">end</span>
0141         <span class="keyword">catch</span>
0142             compartmentIDs{i}=modelSBML.compartment(i).id;
0143         <span class="keyword">end</span>
0144     <span class="keyword">else</span>
0145         compartmentIDs{i}=modelSBML.compartment(i).id(3:end);
0146     <span class="keyword">end</span>
0147     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'outside'</span>)
0148         <span class="keyword">if</span> ~isempty(modelSBML.compartment(i).outside)
0149             <span class="keyword">if</span> isCOBRA==true
0150                 <span class="keyword">try</span> <span class="keyword">if</span> strcmpi(modelSBML.compartment(i).outside(1:2),<span class="string">'C_'</span>)
0151                         compartmentOutside{i}=modelSBML.compartment(i).outside(3:end);
0152                     <span class="keyword">else</span>
0153                         compartmentOutside{i}=modelSBML.compartment(i).outside;
0154                     <span class="keyword">end</span>
0155                 <span class="keyword">catch</span>
0156                     compartmentOutside{i}=modelSBML.compartment(i).outside;
0157                 <span class="keyword">end</span>
0158             <span class="keyword">else</span>
0159                 compartmentOutside{i}=modelSBML.compartment(i).outside(3:end);
0160             <span class="keyword">end</span>
0161         <span class="keyword">else</span>
0162             compartmentOutside{i}=<span class="string">''</span>;
0163         <span class="keyword">end</span>
0164     <span class="keyword">else</span>
0165         compartmentOutside{i}=[];
0166     <span class="keyword">end</span>
0167 
0168     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'annotation'</span>)
0169         compartmentMiriams{i}=<a href="#_sub2" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.compartment(i).annotation);
0170     <span class="keyword">else</span>
0171         compartmentMiriams{i}=[];
0172     <span class="keyword">end</span>
0173 <span class="keyword">end</span>
0174 
0175 <span class="comment">%If there are no compartment names then use compartment id as name</span>
0176 <span class="keyword">if</span> all(cellfun(@isempty,compartmentNames))
0177     compartmentNames=compartmentIDs;
0178 <span class="keyword">end</span>
0179 
0180 <span class="comment">%Retrieve info on metabolites, genes, complexes</span>
0181 metaboliteNames={};
0182 metaboliteIDs={};
0183 metaboliteCompartments={};
0184 metaboliteUnconstrained=[];
0185 metaboliteFormula={};
0186 metaboliteInChI={};
0187 metaboliteMiriams={};
0188 metaboliteCharge=[];
0189 
0190 geneNames={};
0191 geneIDs={};
0192 geneMiriams={};
0193 geneShortNames={};
0194 geneCompartments={};
0195 complexIDs={};
0196 complexNames={};
0197 
0198 <span class="comment">%If the file is not a COBRA Toolbox model. According to the format</span>
0199 <span class="comment">%specified in the yeast consensus model both metabolites and genes are a</span>
0200 <span class="comment">%type of 'species'. The metabolites have names starting with 'M_' and genes</span>
0201 <span class="comment">%with 'E_'.</span>
0202 <span class="keyword">if</span> isCOBRA==false
0203     <span class="keyword">for</span> i=1:numel(modelSBML.species)
0204         <span class="keyword">if</span> strcmpi(modelSBML.species(i).id(1:2),<span class="string">'M_'</span>)
0205             metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0206             metaboliteIDs{numel(metaboliteIDs)+1,1}=modelSBML.species(i).id(3:end);
0207             metaboliteCompartments{numel(metaboliteCompartments)+1,1}=modelSBML.species(i).compartment(3:end);
0208             metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0209 
0210             <span class="comment">%For each metabolite retrieve the formula and the InChI code if</span>
0211             <span class="comment">%available</span>
0212             <span class="comment">%First add the InChI code and the formula from the InChI. This</span>
0213             <span class="comment">%allows for overwriting the formula by setting the actual formula</span>
0214             <span class="comment">%field</span>
0215             <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0216                 <span class="comment">%Get the formula if available</span>
0217                 startString=<span class="string">'&gt;InChI='</span>;
0218                 endString=<span class="string">'&lt;/in:inchi&gt;'</span>;
0219                 formStart=strfind(modelSBML.species(i).annotation,startString);
0220                 <span class="keyword">if</span> ~isempty(formStart)
0221                     formEnd=strfind(modelSBML.species(i).annotation,endString);
0222                     formEndIndex=find(formEnd&gt;formStart, 1 );
0223                     formula=modelSBML.species(i).annotation(formStart+numel(startString):formEnd(formEndIndex)-1);
0224                     metaboliteInChI{numel(metaboliteInChI)+1,1}=formula;
0225 
0226                     <span class="comment">%The composition is most often present between the first</span>
0227                     <span class="comment">%and second &quot;/&quot; in the model. In some simple molecules,</span>
0228                     <span class="comment">%such as salts, there is no second &quot;/&quot;. The formula is then</span>
0229                     <span class="comment">%assumed to be to the end of the string</span>
0230                     compositionIndexes=strfind(formula,<span class="string">'/'</span>);
0231                     <span class="keyword">if</span> numel(compositionIndexes)&gt;1
0232                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0233                             formula(compositionIndexes(1)+1:compositionIndexes(2)-1);
0234                     <span class="keyword">else</span>
0235                         <span class="keyword">if</span> numel(compositionIndexes)==1
0236                             <span class="comment">%Probably a simple molecule which can have only one</span>
0237                             <span class="comment">%conformation</span>
0238                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0239                             formula(compositionIndexes(1)+1:numel(formula));
0240                         <span class="keyword">else</span>
0241                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0242                         <span class="keyword">end</span>
0243                     <span class="keyword">end</span>
0244                 <span class="keyword">else</span>
0245                     metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0246                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0247                 <span class="keyword">end</span>
0248 
0249                 <span class="comment">%Get Miriam info</span>
0250                 metMiriam=<a href="#_sub2" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0251                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0252             <span class="keyword">else</span>
0253                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0254                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0255                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=[];
0256             <span class="keyword">end</span>
0257 
0258             <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0259                 <span class="comment">%Get the formula if available</span>
0260                 startString=<span class="string">'FORMULA:'</span>;
0261                 endString=<span class="string">'&lt;/'</span>;
0262                 formStart=strfind(modelSBML.species(i).notes,startString);
0263                 <span class="keyword">if</span> ~isempty(formStart)
0264                     formEnd=strfind(modelSBML.species(i).notes,endString);
0265                     formEndIndex=find(formEnd&gt;formStart, 1 );
0266                     formula=strtrim(modelSBML.species(i).notes(formStart+numel(startString):formEnd(formEndIndex)-1));
0267                     metaboliteFormula{numel(metaboliteFormula),1}=formula;
0268                 <span class="keyword">end</span>
0269             <span class="keyword">end</span>
0270         <span class="keyword">end</span>
0271 
0272         <span class="keyword">if</span> strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0273             geneNames{numel(geneNames)+1,1}=modelSBML.species(i).name;
0274 
0275             <span class="comment">%The &quot;E_&quot; is included in the ID. This is because it's only used</span>
0276             <span class="comment">%internally in this file and it makes the matching a little</span>
0277             <span class="comment">%smoother</span>
0278             geneIDs{numel(geneIDs)+1,1}=modelSBML.species(i).id;
0279             geneCompartments{numel(geneCompartments)+1,1}=modelSBML.species(i).compartment(3:end);
0280 
0281             <span class="comment">%Get Miriam structure</span>
0282             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0283                 <span class="comment">%Get Miriam info</span>
0284                 geneMiriam=<a href="#_sub2" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0285                 geneMiriams{numel(geneMiriams)+1,1}=geneMiriam;
0286             <span class="keyword">else</span>
0287                 geneMiriams{numel(geneMiriams)+1,1}=[];
0288             <span class="keyword">end</span>
0289 
0290             <span class="comment">%Protein short names (for example ERG10) are saved as SHORT</span>
0291             <span class="comment">%NAME: NAME in the notes-section of metabolites for the &quot;new</span>
0292             <span class="comment">%format&quot; and as PROTEIN_ASSOCIATION for each reaction in COBRA</span>
0293             <span class="comment">%Toolbox format. For now only the SHORT NAME is loaded, and no</span>
0294             <span class="comment">%mapping takes place</span>
0295             <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0296                 <span class="comment">%Get the short name if available</span>
0297                 startString=<span class="string">'SHORT NAME:'</span>;
0298                 endString=<span class="string">'&lt;/'</span>;
0299                 shortStart=strfind(modelSBML.species(i).notes,startString);
0300                 <span class="keyword">if</span> ~isempty(shortStart)
0301                     shortEnd=strfind(modelSBML.species(i).notes,endString);
0302                     shortEndIndex=find(shortEnd&gt;shortStart, 1 );
0303                     shortName=strtrim(modelSBML.species(i).notes(shortStart+numel(startString):shortEnd(shortEndIndex)-1));
0304                     geneShortNames{numel(geneShortNames)+1,1}=shortName;
0305                 <span class="keyword">else</span>
0306                     geneShortNames{numel(geneShortNames)+1,1}=<span class="string">''</span>;
0307                 <span class="keyword">end</span>
0308             <span class="keyword">else</span>
0309                 geneShortNames{numel(geneShortNames)+1,1}=<span class="string">''</span>;
0310             <span class="keyword">end</span>
0311         <span class="keyword">end</span>
0312 
0313         <span class="comment">%If it's a complex keep the ID and name</span>
0314         <span class="keyword">if</span> strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0315             complexIDs=[complexIDs;modelSBML.species(i).id];
0316             complexNames=[complexNames;modelSBML.species(i).name];
0317         <span class="keyword">end</span>
0318     <span class="keyword">end</span>
0319 
0320 <span class="comment">%If it's a COBRA Toolbox file</span>
0321 <span class="keyword">else</span>
0322     <span class="keyword">for</span> i=1:numel(modelSBML.species)
0323         <span class="comment">%The metabolite names are assumed to be M_NAME_COMPOSITION or</span>
0324         <span class="comment">%_NAME_COMPOSITION or NAME_COMPOSITION or NAME</span>
0325         underscoreIndex=strfind(modelSBML.species(i).name,<span class="string">'_'</span>);
0326 
0327         <span class="comment">%Skip the first character if it's an underscore</span>
0328         <span class="keyword">if</span> any(underscoreIndex)
0329             <span class="keyword">if</span> underscoreIndex(1)==1
0330                 metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name(2:max(underscoreIndex)-1);
0331             <span class="keyword">else</span>
0332                 <span class="comment">%If the second character is an underscore than check if the</span>
0333                 <span class="comment">%first is &quot;M&quot;.</span>
0334                 <span class="keyword">if</span> underscoreIndex(1)==2
0335                     <span class="keyword">if</span> modelSBML.species(i).name(1)==<span class="string">'M'</span>
0336                         metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name(3:max(underscoreIndex)-1);
0337                     <span class="keyword">else</span>
0338                         <span class="comment">%If not, then use the full name</span>
0339                         metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name(1:max(underscoreIndex)-1);
0340                     <span class="keyword">end</span>
0341                 <span class="keyword">else</span>
0342                     <span class="comment">%Use the full name</span>
0343                     metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name(1:max(underscoreIndex)-1);
0344                 <span class="keyword">end</span>
0345             <span class="keyword">end</span>
0346         <span class="keyword">else</span>
0347             <span class="comment">% Metabolite names could be of format NAME [compartment]. First</span>
0348             <span class="comment">% check whether metabolite name ends with square brackets, and</span>
0349             <span class="comment">% then check if the text within these brackets is a compartment</span>
0350             <span class="comment">% name. If so, then remove this section from the metabolite</span>
0351             <span class="comment">% name.</span>
0352             comp.match=regexp(modelSBML.species(i).name,<span class="string">'.* \[(.*)\]$'</span>,<span class="string">'match'</span>);
0353             <span class="keyword">if</span> ~isempty(comp.match)
0354                 comp.split=strsplit(comp.match{1},{<span class="string">'['</span>,<span class="string">']'</span>});
0355                 comp.true=any(strcmp({modelSBML.compartment.name},comp.split{2}));
0356                 <span class="keyword">if</span> comp.true==1
0357                     metaboliteNames{numel(metaboliteNames)+1,1}=strtrim(comp.split{1});
0358                 <span class="keyword">else</span>
0359                     metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0360                 <span class="keyword">end</span>
0361             <span class="keyword">else</span>
0362                 <span class="comment">%Use the full name</span>
0363                 metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0364             <span class="keyword">end</span>  
0365         <span class="keyword">end</span>
0366 
0367         metaboliteIDs{numel(metaboliteIDs)+1,1}=modelSBML.species(i).id(3:numel(modelSBML.species(i).id));
0368         <span class="keyword">try</span> <span class="keyword">if</span> strcmpi(modelSBML.species(i).compartment(1:2),<span class="string">'C_'</span>)
0369                 metaboliteCompartments{numel(metaboliteCompartments)+1,1}=modelSBML.species(i).compartment(3:end);
0370             <span class="keyword">else</span>
0371                 metaboliteCompartments{numel(metaboliteCompartments)+1,1}=modelSBML.species(i).compartment;
0372             <span class="keyword">end</span>
0373         <span class="keyword">catch</span>
0374             metaboliteCompartments{numel(metaboliteCompartments)+1,1}=modelSBML.species(i).compartment;
0375         <span class="keyword">end</span>
0376 
0377         <span class="comment">%I think that COBRA doesn't set the boundary condition, but rather</span>
0378         <span class="comment">%uses name_b. Check for either</span>
0379         metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0380         <span class="keyword">if</span> strcmp(metaboliteIDs{end}(max(end-1,1):end),<span class="string">'_b'</span>)
0381             metaboliteUnconstrained(end)=1;
0382         <span class="keyword">end</span>
0383 
0384         <span class="comment">%Get the formula</span>
0385         <span class="keyword">if</span> max(underscoreIndex)&lt;length(modelSBML.species(i).name)
0386             metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).name(max(underscoreIndex)+1:length(modelSBML.species(i).name));
0387         <span class="keyword">else</span>
0388             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0389         <span class="keyword">end</span>
0390 
0391         <span class="comment">%The newer COBRA version sometimes has composition information in</span>
0392         <span class="comment">%the notes instead</span>
0393         <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0394             <span class="comment">%Get the formula if available</span>
0395             startString=<span class="string">'FORMULA:'</span>;
0396             endString=<span class="string">'&lt;/'</span>;
0397             formStart=strfind(modelSBML.species(i).notes,startString);
0398             <span class="keyword">if</span> ~isempty(formStart)
0399                 formEnd=strfind(modelSBML.species(i).notes,endString);
0400                 formEndIndex=find(formEnd&gt;formStart, 1 );
0401                 formula=strtrim(modelSBML.species(i).notes(formStart+numel(startString):formEnd(formEndIndex)-1));
0402                 metaboliteFormula{numel(metaboliteFormula),1}=formula;
0403             <span class="keyword">end</span>
0404         <span class="keyword">end</span>
0405 
0406         <span class="comment">%Additional information from FBC format</span>
0407         <span class="comment">%Chemical formula</span>
0408         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_chemicalFormula'</span>)
0409             metaboliteFormula{numel(metaboliteFormula),1}=modelSBML.species(i).fbc_chemicalFormula;
0410         <span class="keyword">end</span>
0411         <span class="comment">%Charge</span>
0412         <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'fbc_charge'</span>)
0413             metaboliteCharge(numel(metaboliteCharge)+1,1)=modelSBML.species(i).fbc_charge;
0414         <span class="keyword">end</span>
0415         <span class="comment">%% ADD ANNOTATION (KEGG/CHEBI) TO MIRIAM, LOCATED IN SPECIES.ANNOTATION</span>
0416     <span class="keyword">end</span>
0417 <span class="keyword">end</span>
0418 
0419 <span class="comment">%Retrieve info on reactions</span>
0420 reactionNames=cell(numel(modelSBML.reaction),1);
0421 reactionIDs=cell(numel(modelSBML.reaction),1);
0422 subsystems=cell(numel(modelSBML.reaction),1);
0423 subsystems(:,:)=cellstr(<span class="string">''</span>);
0424 eccodes=cell(numel(modelSBML.reaction),1);
0425 eccodes(:,:)=cellstr(<span class="string">''</span>);
0426 grRules=cell(numel(modelSBML.reaction),1);
0427 grRules(:,:)=cellstr(<span class="string">''</span>);
0428 rxnComps=zeros(numel(modelSBML.reaction),1);
0429 rxnMiriams=cell(numel(modelSBML.reaction),1);
0430 reactionReversibility=zeros(numel(modelSBML.reaction),1);
0431 reactionUB=zeros(numel(modelSBML.reaction),1);
0432 reactionLB=zeros(numel(modelSBML.reaction),1);
0433 reactionObjective=zeros(numel(modelSBML.reaction),1);
0434 
0435 <span class="comment">%Construct the stoichiometric matrix while the reaction info is read</span>
0436 S=zeros(numel(metaboliteIDs),numel(modelSBML.reaction));
0437 
0438 counter=0;
0439 <span class="comment">%If FBC, then bounds have parameter ids defined for the whole model</span>
0440 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'parameter'</span>)
0441     parameter.name=cell(numel(modelSBML.parameter),1);
0442     parameter.name={modelSBML.parameter(:).id}';
0443     parameter.value={modelSBML.parameter(:).value}';
0444 <span class="keyword">end</span>
0445 
0446 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0447 
0448     <span class="comment">%Check that the reaction doesn't produce a complex and nothing else.</span>
0449     <span class="comment">%If so, then jump to the next reaction. This is because I get the</span>
0450     <span class="comment">%genes for complexes from the names and not from the reactions that</span>
0451     <span class="comment">%create them. This only applies to the non-COBRA format.</span>
0452     <span class="keyword">if</span> numel(modelSBML.reaction(i).product)==1
0453         <span class="keyword">if</span> strcmp(modelSBML.reaction(i).product(1).species(1:3),<span class="string">'Cx_'</span>)==true
0454             <span class="keyword">continue</span>;
0455         <span class="keyword">end</span>
0456     <span class="keyword">end</span>
0457 
0458     <span class="comment">%It didn't look like a gene complex-forming reaction</span>
0459     counter=counter+1;
0460 
0461     <span class="keyword">if</span> isCOBRA &amp;&amp; numel(modelSBML.reaction(i).name)&gt;2
0462         <span class="comment">%In COBRA the reaction names starts with &quot;R_&quot; but I check to be</span>
0463         <span class="comment">%sure</span>
0464         <span class="keyword">if</span> strcmp(modelSBML.reaction(i).name(1:2),<span class="string">'R_'</span>)
0465             reactionNames{counter}=modelSBML.reaction(i).name(3:end);
0466         <span class="keyword">else</span>
0467             reactionNames{counter}=modelSBML.reaction(i).name;
0468         <span class="keyword">end</span>
0469     <span class="keyword">else</span>
0470         reactionNames{counter}=modelSBML.reaction(i).name;
0471     <span class="keyword">end</span>
0472 
0473     <span class="comment">%Assumes that the ID starts with &quot;R_&quot;</span>
0474     reactionIDs{counter}=modelSBML.reaction(i).id(3:end);
0475     reactionReversibility(counter)=modelSBML.reaction(i).reversible;
0476 
0477     <span class="comment">%If model is FBC, first get parameter of bound and then replace it</span>
0478     <span class="comment">%with the correct value. Probably faster with replace(), but this was</span>
0479     <span class="comment">%only introduced in Matlab R2016b</span>
0480     <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_lowerFluxBound'</span>)
0481         lb=modelSBML.reaction(i).fbc_lowerFluxBound;
0482         ub=modelSBML.reaction(i).fbc_upperFluxBound;
0483         <span class="keyword">for</span> n=1:numel(parameter.value)
0484             lb=regexprep(lb,parameter.name(n),num2str(parameter.value{n}));
0485             ub=regexprep(ub,parameter.name(n),num2str(parameter.value{n}));
0486         <span class="keyword">end</span>
0487         reactionLB(counter)=str2num(lb);
0488         reactionUB(counter)=str2num(ub);
0489     <span class="comment">%The order of these parameters should not be hard coded</span>
0490     <span class="keyword">elseif</span> isfield(modelSBML.reaction(i).kineticLaw,<span class="string">'parameter'</span>)
0491         reactionLB(counter)=modelSBML.reaction(i).kineticLaw.parameter(1).value;
0492         reactionUB(counter)=modelSBML.reaction(i).kineticLaw.parameter(2).value;
0493         reactionObjective(counter)=modelSBML.reaction(i).kineticLaw.parameter(3).value;
0494     <span class="keyword">else</span>
0495         <span class="keyword">if</span> reactionReversibility(counter)==true
0496             reactionLB(counter)=-inf;
0497         <span class="keyword">else</span>
0498             reactionLB(counter)=0;
0499         <span class="keyword">end</span>
0500         reactionUB(counter)=inf;
0501         reactionObjective(counter)=0;
0502     <span class="keyword">end</span>
0503 
0504     <span class="comment">%Find the associated gene if available</span>
0505     <span class="keyword">if</span> isCOBRA==false
0506         <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'modifier'</span>)
0507             <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).modifier)
0508                 rules=<span class="string">''</span>;
0509                 <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).modifier)
0510                     modifier=modelSBML.reaction(i).modifier(j).species;
0511                     <span class="keyword">if</span> ~isempty(modifier)
0512                         <span class="keyword">if</span> strfind(modifier,<span class="string">'E_'</span>)
0513                             index=find(strcmp(modifier,geneIDs));
0514                             <span class="comment">%This should be unique and in the geneIDs list, otherwise</span>
0515                             <span class="comment">%something is wrong</span>
0516                             <span class="keyword">if</span> numel(index)~=1
0517                                 EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0518                                 dispEM(EM);
0519                             <span class="keyword">end</span>
0520                             <span class="comment">%Add the association</span>
0521                             <span class="comment">%rxnGeneMat(i,index)=1;</span>
0522                             <span class="keyword">if</span> ~isempty(rules)
0523                                 rules=[rules <span class="string">' or ('</span> geneNames{index} <span class="string">')'</span>];
0524                             <span class="keyword">else</span>
0525                                 rules=[<span class="string">'('</span> geneNames{index} <span class="string">')'</span>];
0526                             <span class="keyword">end</span>
0527                         <span class="keyword">else</span>
0528                            <span class="comment">%It seems to be a complex. Add the corresponding</span>
0529                            <span class="comment">%genes from the name of the complex (not the</span>
0530                            <span class="comment">%reaction that creates it)</span>
0531                            index=find(strcmp(modifier,complexIDs));
0532                            <span class="keyword">if</span> numel(index)==1
0533                                <span class="keyword">if</span> ~isempty(rules)
0534                                     rules=[rules <span class="string">' or ('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0535                                 <span class="keyword">else</span>
0536                                     rules=[<span class="string">'('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0537                                <span class="keyword">end</span>
0538                            <span class="keyword">else</span>
0539                               <span class="comment">%Could not find a complex</span>
0540                               EM=[<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}];
0541                               dispEM(EM);
0542                            <span class="keyword">end</span>
0543                         <span class="keyword">end</span>
0544                     <span class="keyword">end</span>
0545                 <span class="keyword">end</span>
0546                 grRules{counter}=rules;
0547             <span class="keyword">end</span>
0548         <span class="keyword">end</span>
0549     <span class="keyword">else</span>
0550         <span class="comment">%Get gene association for COBRA Toolbox models. The genes are added</span>
0551         <span class="comment">%here as well as the associations. Gene complexes are ok, but only</span>
0552         <span class="comment">%if they are on the form (A and B and...)</span>
0553         <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'fbc_geneProductAssociation'</span>) &amp; ~isempty(modelSBML.reaction(i).fbc_geneProductAssociation)
0554             grRules{counter}=modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association.fbc_association;
0555         <span class="keyword">elseif</span> ~isempty(modelSBML.reaction(i).notes)
0556             startString=<span class="string">'GENE_ASSOCIATION:'</span>;
0557             endString=<span class="string">'&lt;/'</span>;
0558             geneStart=strfind(modelSBML.reaction(i).notes,startString);
0559             <span class="keyword">if</span> isempty(geneStart)
0560                 startString=<span class="string">'GENE ASSOCIATION:'</span>;
0561                 geneStart=strfind(modelSBML.reaction(i).notes,startString);
0562             <span class="keyword">end</span>
0563             <span class="keyword">if</span> ~isempty(geneStart)
0564                 geneEnd=strfind(modelSBML.reaction(i).notes,endString);
0565                 geneEndIndex=find(geneEnd&gt;geneStart, 1 );
0566                 geneAssociation=strtrim(modelSBML.reaction(i).notes(geneStart+numel(startString):geneEnd(geneEndIndex)-1));
0567                 <span class="keyword">if</span> ~isempty(geneAssociation)
0568                     <span class="comment">%This adds the grRules. The gene list and rxnGeneMat</span>
0569                     <span class="comment">%are created later</span>
0570                     grRules{counter}=geneAssociation;
0571                 <span class="keyword">end</span>
0572             <span class="keyword">end</span>
0573         <span class="keyword">end</span>
0574     <span class="keyword">end</span>
0575 
0576     <span class="comment">%Add subsystems and reaction compartment</span>
0577     <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).notes)
0578         <span class="comment">%Get the subsystem if available</span>
0579         startString=<span class="string">'SUBSYSTEM:'</span>;
0580         endString=<span class="string">'&lt;/'</span>;
0581         subStart=strfind(modelSBML.reaction(i).notes,startString);
0582         <span class="keyword">if</span> ~isempty(subStart)
0583             subEnd=strfind(modelSBML.reaction(i).notes,endString);
0584             subEndIndex=find(subEnd&gt;subStart, 1 );
0585             subsystem=strtrim(modelSBML.reaction(i).notes(subStart+numel(startString):subEnd(subEndIndex)-1));
0586             subsystems{counter}=subsystem;
0587         <span class="keyword">end</span>
0588         startString=<span class="string">'COMPARTMENT:'</span>;
0589         endString=<span class="string">'&lt;/'</span>;
0590         compStart=strfind(modelSBML.reaction(i).notes,startString);
0591         <span class="keyword">if</span> ~isempty(compStart)
0592             compEnd=strfind(modelSBML.reaction(i).notes,endString);
0593             compEndIndex=find(compEnd&gt;compStart, 1 );
0594             rxnComp=strtrim(modelSBML.reaction(i).notes(compStart+numel(startString):compEnd(compEndIndex)-1));
0595             <span class="comment">%Find it in the compartment list</span>
0596             [~, J]=ismember(rxnComp,compartmentIDs);
0597             rxnComps(counter)=J;
0598         <span class="keyword">end</span>
0599     <span class="keyword">end</span>
0600 
0601     <span class="comment">%Get ec-codes</span>
0602     flagEmpty=false;
0603     <span class="keyword">if</span> isCOBRA==false
0604         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).annotation)
0605             searchString=modelSBML.reaction(i).annotation;
0606             startString=<span class="string">'urn:miriam:ec-code:'</span>;
0607             endString=<span class="string">'&quot;'</span>;
0608         <span class="keyword">else</span>
0609             flagEmpty=true;
0610         <span class="keyword">end</span>
0611     <span class="keyword">else</span>
0612         <span class="keyword">if</span> isfield(modelSBML,<span class="string">'fbc_version'</span>)
0613             <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).notes)
0614                 searchString=modelSBML.reaction(i).notes;
0615                 startString=<span class="string">'EC Number:'</span>;
0616                 endString=<span class="string">'&lt;/'</span>;
0617             <span class="keyword">else</span>
0618                 flagempty=true;
0619             <span class="keyword">end</span>
0620         <span class="keyword">else</span>
0621             <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).notes)
0622                 searchString=modelSBML.reaction(i).notes;
0623                 startString=<span class="string">'PROTEIN_CLASS:'</span>;
0624                 endString=<span class="string">'&lt;/'</span>;
0625             <span class="keyword">else</span>
0626                 flagEmpty=true;
0627             <span class="keyword">end</span>
0628         <span class="keyword">end</span>
0629     <span class="keyword">end</span>
0630 
0631     <span class="keyword">if</span> flagEmpty==false
0632         ecStart=strfind(searchString,startString);
0633         ecEnd=strfind(searchString,endString);
0634         <span class="comment">%There can be several ec-codes, but they should be merged to one</span>
0635         <span class="comment">%string</span>
0636         <span class="keyword">for</span> j=1:numel(ecStart)
0637             ecEndIndex=find(ecEnd&gt;ecStart(j), 1 );
0638             eccode=strtrim(searchString(ecStart(j)+numel(startString):ecEnd(ecEndIndex)-1));
0639             <span class="keyword">if</span> j==1
0640                 eccodes{counter}=eccode;
0641             <span class="keyword">else</span>
0642                 eccodes{counter}=[eccodes{counter} <span class="string">';'</span> eccode];
0643             <span class="keyword">end</span>
0644         <span class="keyword">end</span>
0645     <span class="keyword">end</span>
0646 
0647     <span class="comment">%Get other Miriam fields. This may include for example database indexes</span>
0648     <span class="comment">%to organism-specific databases. EC-codes are supported by the COBRA</span>
0649     <span class="comment">%Toolbox format and are therefore loaded separately</span>
0650     <span class="keyword">if</span> isCOBRA==false
0651         miriamStruct=<a href="#_sub2" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.reaction(i).annotation);
0652         rxnMiriams{counter}=miriamStruct;
0653     <span class="keyword">end</span>
0654 
0655     <span class="comment">%Add all reactants</span>
0656     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0657        <span class="comment">%Get the index of the metabolite in metaboliteIDs. External</span>
0658        <span class="comment">%metabolites will be removed at a later stage</span>
0659        <span class="comment">%Assumes that all metabolites start with &quot;M_&quot;</span>
0660        metIndex=find(strcmp(modelSBML.reaction(i).reactant(j).species(3:end),metaboliteIDs),1);
0661        <span class="keyword">if</span> isempty(metIndex)
0662            EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species(3:end) <span class="string">' in reaction '</span> reactionIDs{counter}];
0663            dispEM(EM);
0664        <span class="keyword">end</span>
0665        S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).reactant(j).stoichiometry*-1;
0666     <span class="keyword">end</span>
0667 
0668     <span class="comment">%Add all products</span>
0669     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0670        <span class="comment">%Get the index of the metabolite in metaboliteIDs.</span>
0671        <span class="comment">%Assumes that all metabolites start with &quot;M_&quot;</span>
0672        metIndex=find(strcmp(modelSBML.reaction(i).product(j).species(3:end),metaboliteIDs),1);
0673        <span class="keyword">if</span> isempty(metIndex)
0674            EM=[<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species(3:end) <span class="string">' in reaction '</span> reactionIDs{counter}];
0675            dispEM(EM);
0676        <span class="keyword">end</span>
0677        S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).product(j).stoichiometry;
0678     <span class="keyword">end</span>
0679 <span class="keyword">end</span>
0680 
0681 <span class="comment">%Shrink the structures if complex-forming reactions had to be skipped</span>
0682 reactionNames=reactionNames(1:counter);
0683 reactionIDs=reactionIDs(1:counter);
0684 subsystems=subsystems(1:counter);
0685 eccodes=eccodes(1:counter);
0686 grRules=grRules(1:counter);
0687 rxnMiriams=rxnMiriams(1:counter);
0688 reactionReversibility=reactionReversibility(1:counter);
0689 reactionUB=reactionUB(1:counter);
0690 reactionLB=reactionLB(1:counter);
0691 reactionObjective=reactionObjective(1:counter);
0692 S=S(:,1:counter);
0693 
0694 model.description=modelSBML.name;
0695 model.id=modelSBML.id;
0696 model.rxns=reactionIDs;
0697 model.mets=metaboliteIDs;
0698 model.S=sparse(S);
0699 model.lb=reactionLB;
0700 model.ub=reactionUB;
0701 model.rev=reactionReversibility;
0702 model.c=reactionObjective;
0703 model.b=zeros(numel(metaboliteIDs),1);
0704 model.comps=compartmentIDs;
0705 model.compNames=compartmentNames;
0706 
0707 <span class="comment">%Load annotation if available</span>
0708 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'annotation'</span>)
0709     endString=<span class="string">'&lt;/'</span>;
0710     I=strfind(modelSBML.annotation,endString);
0711     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Family&gt;'</span>);
0712     <span class="keyword">if</span> any(J)
0713        model.annotation.familyName=modelSBML.annotation(J+14:I(find(I&gt;J,1))-1);
0714     <span class="keyword">end</span>
0715     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Given&gt;'</span>);
0716     <span class="keyword">if</span> any(J)
0717        model.annotation.givenName=modelSBML.annotation(J+13:I(find(I&gt;J,1))-1);
0718     <span class="keyword">end</span>
0719     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:EMAIL&gt;'</span>);
0720     <span class="keyword">if</span> any(J)
0721        model.annotation.email=modelSBML.annotation(J+13:I(find(I&gt;J,1))-1);
0722     <span class="keyword">end</span>
0723     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Orgname&gt;'</span>);
0724     <span class="keyword">if</span> any(J)
0725        model.annotation.organization=modelSBML.annotation(J+15:I(find(I&gt;J,1))-1);
0726     <span class="keyword">end</span>
0727     endString=<span class="string">'&quot;/&gt;'</span>;
0728     I=strfind(modelSBML.annotation,endString);
0729     J=strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>);
0730     <span class="keyword">if</span> any(J)
0731        model.annotation.taxonomy=modelSBML.annotation(J+12:I(find(I&gt;J,1))-1);
0732     <span class="keyword">end</span>
0733 <span class="keyword">end</span>
0734 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'notes'</span>)
0735     startString=strfind(modelSBML.notes,<span class="string">'xhtml&quot;&gt;'</span>);
0736     endString=strfind(modelSBML.notes,<span class="string">'&lt;/body&gt;'</span>);
0737     <span class="keyword">if</span> any(startString) &amp;&amp; any(endString)
0738        model.annotation.note=modelSBML.notes(startString+7:endString-1);
0739     <span class="keyword">end</span>
0740 <span class="keyword">end</span>
0741 
0742 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentOutside))
0743     model.compOutside=compartmentOutside;
0744 <span class="keyword">end</span>
0745 
0746 model.rxnNames=reactionNames;
0747 model.metNames=metaboliteNames;
0748 
0749 <span class="comment">%Match the compartments for metabolites</span>
0750 [~, J]=ismember(metaboliteCompartments,model.comps);
0751 model.metComps=J;
0752 
0753 <span class="comment">%If any genes have been loaded (only for the new format)</span>
0754 <span class="keyword">if</span> ~isempty(geneNames)
0755     model.genes=geneNames;
0756     model.rxnGeneMat=<a href="#_sub1" class="code" title="subfunction [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)">getGeneMat</a>(grRules,geneNames);
0757     model.grRules=grRules;
0758     <span class="comment">%Match the compartments for genes</span>
0759     [~, J]=ismember(geneCompartments,model.comps);
0760     model.geneComps=J;
0761 <span class="keyword">else</span>
0762     <span class="keyword">if</span> ~isempty(grRules)
0763        grRules=strrep(grRules,<span class="string">' AND '</span>,<span class="string">' and '</span>);
0764        grRules=strrep(grRules,<span class="string">' OR '</span>,<span class="string">' or '</span>);
0765        <span class="comment">%In the non-COBRA version genes are surrounded by parenthesis even</span>
0766        <span class="comment">%if they are the only gene. Also, only single spaces are used</span>
0767        <span class="comment">%between genes. I'm pretty sure this is compatible with COBRA Toolbox so I</span>
0768        <span class="comment">%change it to be the same here.</span>
0769        grRules=strrep(grRules,<span class="string">'  '</span>,<span class="string">' '</span>);
0770        grRules=strrep(grRules,<span class="string">'(('</span>,<span class="string">'('</span>);
0771        grRules=strrep(grRules,<span class="string">'))'</span>,<span class="string">')'</span>);
0772        grRules=strrep(grRules,<span class="string">'( '</span>,<span class="string">'('</span>);
0773        grRules=strrep(grRules,<span class="string">' )'</span>,<span class="string">')'</span>);
0774        grRules=strrep(grRules,<span class="string">') or ('</span>,<span class="string">'*%%%%*'</span>);
0775        grRules=strrep(grRules,<span class="string">' or '</span>,<span class="string">') or ('</span>);
0776        grRules=strrep(grRules,<span class="string">'*%%%%*'</span>,<span class="string">') or ('</span>);
0777 
0778        <span class="comment">%Not very neat, but add parenthesis if missing</span>
0779        <span class="keyword">for</span> i=1:numel(grRules)
0780           <span class="keyword">if</span> any(grRules{i})
0781               <span class="keyword">if</span> ~strcmp(grRules{i}(1),<span class="string">'('</span>)
0782                   grRules{i}=[<span class="string">'('</span> grRules{i} <span class="string">')'</span>];
0783               <span class="keyword">end</span>
0784           <span class="keyword">end</span>
0785        <span class="keyword">end</span>
0786        [rxnGeneMat, genes]=<a href="#_sub1" class="code" title="subfunction [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)">getGeneMat</a>(grRules);
0787        model.rxnGeneMat=rxnGeneMat;
0788        model.genes=genes;
0789        model.grRules=grRules;
0790     <span class="keyword">end</span>
0791 <span class="keyword">end</span>
0792 
0793 <span class="comment">%If any InChIs have been loaded</span>
0794 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteInChI))
0795     model.inchis=metaboliteInChI;
0796 <span class="keyword">end</span>
0797 
0798 <span class="comment">%If any formulas have been loaded</span>
0799 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteFormula))
0800     model.metFormulas=metaboliteFormula;
0801 <span class="keyword">end</span>
0802 
0803 <span class="comment">%If any charges have been loaded</span>
0804 <span class="keyword">if</span> ~isempty(metaboliteCharge)
0805     model.metCharge=metaboliteCharge;
0806 <span class="keyword">end</span>
0807 
0808 <span class="comment">%If any gene short names have been loaded</span>
0809 <span class="keyword">if</span> any(~cellfun(@isempty,geneShortNames))
0810     model.geneShortNames=geneShortNames;
0811 <span class="keyword">end</span>
0812 
0813 <span class="comment">%If any Miriam strings for compartments have been loaded</span>
0814 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentMiriams))
0815     model.compMiriams=compartmentMiriams;
0816 <span class="keyword">end</span>
0817 
0818 <span class="comment">%If any Miriam strings for metabolites have been loaded</span>
0819 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteMiriams))
0820     model.metMiriams=metaboliteMiriams;
0821 <span class="keyword">end</span>
0822 
0823 <span class="comment">%If any subsystems have been loaded</span>
0824 <span class="keyword">if</span> any(~cellfun(@isempty,subsystems))
0825     model.subSystems=subsystems;
0826 <span class="keyword">end</span>
0827 <span class="keyword">if</span> any(rxnComps)
0828    <span class="keyword">if</span> all(rxnComps)
0829        model.rxnComps=rxnComps;
0830    <span class="keyword">else</span>
0831        <span class="keyword">if</span> supressWarnings==false
0832            EM=<span class="string">'The compartments for the following reactions could not be matched. Ignoring reaction compartment information'</span>;
0833            dispEM(EM,false,model.rxns(rxnComps==0));
0834        <span class="keyword">end</span>
0835    <span class="keyword">end</span>
0836 <span class="keyword">end</span>
0837 
0838 <span class="comment">%If any ec-codes have been loaded</span>
0839 <span class="keyword">if</span> any(~cellfun(@isempty,eccodes))
0840     model.eccodes=eccodes;
0841 <span class="keyword">end</span>
0842 
0843 <span class="comment">%If any Miriam strings for reactions have been loaded</span>
0844 <span class="keyword">if</span> any(~cellfun(@isempty,rxnMiriams))
0845     model.rxnMiriams=rxnMiriams;
0846 <span class="keyword">end</span>
0847 
0848 <span class="comment">%If any Miriam strings for genes have been loaded</span>
0849 <span class="keyword">if</span> any(~cellfun(@isempty,geneMiriams))
0850     model.geneMiriams=geneMiriams;
0851 <span class="keyword">end</span>
0852 
0853 model.unconstrained=metaboliteUnconstrained;
0854 
0855 <span class="comment">%Remove unused fields</span>
0856 <span class="keyword">if</span> isempty(model.annotation)
0857     model=rmfield(model,<span class="string">'annotation'</span>);
0858 <span class="keyword">end</span>
0859 <span class="keyword">if</span> isempty(model.compOutside)
0860     model=rmfield(model,<span class="string">'compOutside'</span>);
0861 <span class="keyword">end</span>
0862 <span class="keyword">if</span> isempty(model.compMiriams)
0863     model=rmfield(model,<span class="string">'compMiriams'</span>);
0864 <span class="keyword">end</span>
0865 <span class="keyword">if</span> isempty(model.rxnComps)
0866     model=rmfield(model,<span class="string">'rxnComps'</span>);
0867 <span class="keyword">end</span>
0868 <span class="keyword">if</span> isempty(model.grRules)
0869     model=rmfield(model,<span class="string">'grRules'</span>);
0870 <span class="keyword">end</span>
0871 <span class="keyword">if</span> isempty(model.rxnGeneMat)
0872     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
0873 <span class="keyword">end</span>
0874 <span class="keyword">if</span> isempty(model.subSystems)
0875     model=rmfield(model,<span class="string">'subSystems'</span>);
0876 <span class="keyword">end</span>
0877 <span class="keyword">if</span> isempty(model.eccodes)
0878     model=rmfield(model,<span class="string">'eccodes'</span>);
0879 <span class="keyword">end</span>
0880 <span class="keyword">if</span> isempty(model.rxnMiriams)
0881     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
0882 <span class="keyword">end</span>
0883 <span class="keyword">if</span> isempty(model.genes)
0884     model=rmfield(model,<span class="string">'genes'</span>);
0885 <span class="keyword">end</span>
0886 <span class="keyword">if</span> isempty(model.geneComps)
0887     model=rmfield(model,<span class="string">'geneComps'</span>);
0888 <span class="keyword">end</span>
0889 <span class="keyword">if</span> isempty(model.geneMiriams)
0890     model=rmfield(model,<span class="string">'geneMiriams'</span>);
0891 <span class="keyword">end</span>
0892 <span class="keyword">if</span> isempty(model.inchis)
0893     model=rmfield(model,<span class="string">'inchis'</span>);
0894 <span class="keyword">end</span>
0895 <span class="keyword">if</span> isempty(model.metFormulas)
0896     model=rmfield(model,<span class="string">'metFormulas'</span>);
0897 <span class="keyword">end</span>
0898 <span class="keyword">if</span> isempty(model.metMiriams)
0899     model=rmfield(model,<span class="string">'metMiriams'</span>);
0900 <span class="keyword">end</span>
0901 <span class="keyword">if</span> isempty(model.metCharge)
0902     model=rmfield(model,<span class="string">'metCharge'</span>);
0903 <span class="keyword">end</span>
0904 
0905 <span class="comment">%This just removes the grRules if no genes have been loaded</span>
0906 <span class="keyword">if</span> ~isfield(model,<span class="string">'genes'</span>) &amp;&amp; isfield(model,<span class="string">'grRules'</span>)
0907    model=rmfield(model,<span class="string">'grRules'</span>);
0908 <span class="keyword">end</span>
0909 
0910 <span class="comment">%Print warnings about bad structure</span>
0911 <span class="keyword">if</span> supressWarnings==false
0912     checkModelStruct(model,false);
0913 <span class="keyword">end</span>
0914 
0915 <span class="keyword">if</span> removeExcMets==true
0916     model=simplifyModel(model);
0917 <span class="keyword">end</span>
0918 <span class="keyword">end</span>
0919 
0920 <a name="_sub1" href="#_subfunctions" class="code">function [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)</a>
0921 <span class="comment">%Constructs the rxnGeneMat matrix and the cell array with gene names from</span>
0922 <span class="comment">%the grRules. Uses the genes in the order defined by matchGenes if supplied. No</span>
0923 <span class="comment">%checks are made here since that should have been made before.</span>
0924 
0925 <span class="keyword">if</span> nargin&lt;2
0926     matchGenes={};
0927 <span class="keyword">end</span>
0928 
0929 <span class="comment">%Assume that everything that isn't a paranthesis, &quot; AND &quot; or &quot; or &quot; is a</span>
0930 <span class="comment">%gene name</span>
0931 genes=strrep(grRules,<span class="string">'('</span>,<span class="string">''</span>);
0932 genes=strrep(genes,<span class="string">')'</span>,<span class="string">''</span>);
0933 genes=strrep(genes,<span class="string">' or '</span>,<span class="string">' '</span>);
0934 genes=strrep(genes,<span class="string">' and '</span>,<span class="string">' '</span>);
0935 genes=regexp(genes,<span class="string">' '</span>,<span class="string">'split'</span>);
0936 
0937 <span class="keyword">if</span> isempty(matchGenes)
0938     allNames={};
0939     <span class="keyword">for</span> i=1:numel(genes)
0940         allNames=[allNames genes{i}];
0941     <span class="keyword">end</span>
0942     matchGenes=unique(allNames)';
0943 
0944     <span class="comment">%Remove the empty element if present</span>
0945     <span class="keyword">if</span> isempty(matchGenes{1})
0946         matchGenes(1)=[];
0947     <span class="keyword">end</span>
0948 <span class="keyword">end</span>
0949 
0950 <span class="comment">%Create the matrix</span>
0951 rxnGeneMat=zeros(numel(genes),numel(matchGenes));
0952 
0953 <span class="keyword">for</span> i=1:numel(genes)
0954     <span class="keyword">if</span> ~isempty(genes{i})
0955         <span class="keyword">for</span> j=1:numel(genes{i})
0956             <span class="keyword">if</span> ~isempty(genes{i}{j})
0957                 index=find(strcmp(genes{i}{j},matchGenes));
0958                 <span class="keyword">if</span> numel(index)==1
0959                     rxnGeneMat(i,index)=1;
0960                 <span class="keyword">else</span>
0961                     EM=[<span class="string">'The gene '</span> genes{i}{j} <span class="string">' could not be matched to a gene in the gene list'</span>];
0962                     dispEM(EM);
0963                 <span class="keyword">end</span>
0964             <span class="keyword">end</span>
0965         <span class="keyword">end</span>
0966     <span class="keyword">end</span>
0967 <span class="keyword">end</span>
0968 rxnGeneMat=sparse(rxnGeneMat);
0969 <span class="keyword">end</span>
0970 
0971 <a name="_sub2" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(searchString)</a>
0972 <span class="comment">%Gets the names and values of Miriam-string. Nothing fancy at all, just to</span>
0973 <span class="comment">%prevent using the same code for metabolites, genes, and reactions</span>
0974 
0975 <span class="keyword">if</span> ~isempty(searchString)
0976     startString=<span class="string">'urn:miriam:'</span>;
0977     midString=<span class="string">':'</span>;
0978     endString=<span class="string">'&quot;'</span>;
0979     startIndexes=strfind(searchString,startString);
0980     midIndexes=strfind(searchString,midString);
0981     endIndexes=strfind(searchString,endString);
0982     miriamStruct=[];
0983 
0984     <span class="keyword">if</span> ~isempty(startIndexes)
0985         counter=0;
0986         <span class="keyword">for</span> j=1:numel(startIndexes)
0987             endIndex=find(endIndexes&gt;startIndexes(j)+numel(startString), 1 );
0988 
0989             midIndex=find(midIndexes&gt;startIndexes(j)+numel(startString) &amp; midIndexes&lt;endIndexes(endIndex),1);
0990 
0991             <span class="comment">%It was like this before and I don't understand why!</span>
0992             <span class="comment">%midIndex=find(midIndexes&lt;endIndexes(endIndex),1,'last');</span>
0993 
0994             miriam=searchString(startIndexes(j)+numel(startString):midIndexes(midIndex)-1);
0995 
0996             <span class="comment">%Construct the struct</span>
0997             <span class="keyword">if</span> ~strcmpi(miriam,<span class="string">'ec-code'</span>)
0998                 counter=counter+1;
0999                 miriamStruct.name{counter,1}=miriam;
1000                 <span class="keyword">if</span> any(midIndex)
1001                     miriamStruct.value{counter,1}=searchString(midIndexes(midIndex)+1:endIndexes(endIndex)-1);
1002                 <span class="keyword">else</span>
1003                     <span class="comment">%This is if there is no miriam type defined, but that</span>
1004                     <span class="comment">%there still is some value defined</span>
1005                     miriamStruct.value{counter,1}=searchString(startIndexes(j)+numel(startString):endIndexes(endIndex)-1);
1006                 <span class="keyword">end</span>
1007             <span class="keyword">end</span>
1008         <span class="keyword">end</span>
1009     <span class="keyword">end</span>
1010 <span class="keyword">else</span>
1011     miriamStruct=[];
1012 <span class="keyword">end</span>
1013 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 28-Feb-2017 23:41:43 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>